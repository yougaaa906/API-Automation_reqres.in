# Workflow name (English for international team compatibility)
name: Reqres API Automation Test

# Trigger conditions:
# 1. Push/Pull Request to main branch (code change trigger)
# 2. Scheduled run (daily at 02:00 AM Beijing time, UTC+8)
# 3. Manual trigger (allow ad-hoc test execution)
on:
  push:
    branches: [ main ]
    paths:
      - 'common/**'
      - 'config/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/api-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'common/**'
      - 'config/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/api-test.yml'
  schedule:
    - cron: '0 18 * * *'  # UTC time = Beijing time - 8 hours (02:00 AM Beijing time)
  workflow_dispatch:  # Enable manual trigger from GitHub UI

# Job definition (single job for API test execution)
jobs:
  api-automation-test:
    # Run on latest Ubuntu (stable environment for Python testing)
    runs-on: ubuntu-latest
    # Set environment variables (non-sensitive config)
    env:
      API_BASE_URL: "https://reqres.in"
      REQUEST_TIMEOUT: "10"
      SSL_VERIFY: "False"
    # Set secrets (sensitive config - configure in GitHub repo Settings > Secrets and variables > Actions)
    secrets:
      API_TEST_USERNAME: ${{ secrets.API_TEST_USERNAME }}
      API_TEST_PASSWORD: ${{ secrets.API_TEST_PASSWORD }}
      API_FIXED_TOKEN: ${{ secrets.API_FIXED_TOKEN }}

    # Execution steps (ordered by dependency)
    steps:
      # Step 1: Checkout code from GitHub repository
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Fetch only latest commit (faster)

      # Step 2: Set up Python environment (match local test environment)
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'  # Cache pip dependencies for faster runs

      # Step 3: Install required Python packages
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          # Verify installed packages (debug purpose)
          pip list

      # Step 4: Export secrets to environment variables (make available to test scripts)
      - name: Export secrets to environment
        run: |
          echo "API_TEST_USERNAME=${{ secrets.API_TEST_USERNAME }}" >> $GITHUB_ENV
          echo "API_TEST_PASSWORD=${{ secrets.API_TEST_PASSWORD }}" >> $GITHUB_ENV
          echo "API_FIXED_TOKEN=${{ secrets.API_FIXED_TOKEN }}" >> $GITHUB_ENV

      # Step 5: Run API automation test cases with pytest
      - name: Execute API test cases
        run: |
          # Run tests and generate HTML report (self-contained for easy sharing)
          pytest tests/ -v --html=test-report.html --self-contained-html --tb=short
        continue-on-error: false  # Fail workflow if tests fail (enforce quality gate)

      # Step 6: Upload test report as artifact (accessible after workflow run)
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: reqres-api-test-report
          path: test-report.html
          retention-days: 7  # Keep report for 7 days (clean up old artifacts)
        if: always()  # Upload report even if tests fail (critical for debugging)
