# Saucedemo API Automation CI/CD Pipeline
# Trigger: Push/Pull Request to main branch
name: Saucedemo API Automation Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Job Configuration (single job for simplicity)
jobs:
  api-automation-test:
    # Run on latest Ubuntu (compatible with Python/pytest)
    runs-on: ubuntu-latest
    # Set environment variables (pass to config.py)
    env:
      TEST_ENV: "test"
      REPORT_PATH: "./test-report.html"
    
    # Step-by-step execution
    steps:
      # Step 1: Pull code from GitHub repository
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      # Step 2: Set up Python 3.9 (match local environment)
      - name: Set Up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          # Cache Python dependencies (speed up CI)
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # Step 3: Install required dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Execute API Test Cases (generate HTML report)
      - name: Run API Automation Tests
        run: |
          pytest tests/test_saucedemo_api.py -v \
            --html=${{ env.REPORT_PATH }} \
            --self-contained-html \
            --tb=short  # Simplify error traceback (clean log)

      # Step 5: Upload Test Report as Artifact (online view)
      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: saucedemo-api-test-report
          path: ${{ env.REPORT_PATH }}
          # Keep report for 7 days (balance storage/availability)
          retention-days: 7
          # Ensure report is uploaded even if tests fail
          if: always()
